name: Publish to Crates.io

on:
  release:
    types: [created]

permissions:  
  contents: write

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Sync version with tag
        shell: bash
        run: |
          # Extract version from tag (remove 'v' prefix)
          VERSION=${GITHUB_REF_NAME#v}
          echo "Syncing Cargo.toml to version $VERSION"
          
          # Update Cargo.toml
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
          
          # Update Cargo.lock
          cargo check
          
          # Config git for committing
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Commit and push to master (so repo stays in sync)
          # We force push to master? No, better to pull --rebase or just push.
          # Since this is running on a tag, we need to checkout master to push to it?
          # Or we just push the change.
          # Let's try to commit locally for the publish step first.
          git add Cargo.toml Cargo.lock
          git commit -m "Bump version to $VERSION [skip ci]" || echo "No changes to commit"

      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Push version bump to master
        run: |
           # We need to push this commit to master.
           # Fetch master
           git fetch origin master
           # Checkout master
           git checkout master
           # Cherry-pick the commit we just made? Or apply changes?
           # Easiest: Just re-apply the sed and push.
           VERSION=${GITHUB_REF_NAME#v}
           sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
           cargo check
           git add Cargo.toml Cargo.lock
           git commit -m "Bump version to $VERSION [skip ci]" || echo "Already up to date"
           git push origin master